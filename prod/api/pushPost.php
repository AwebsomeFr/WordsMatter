<?php  ini_set('display_errors', true); ini_set('html_errors', false); error_reporting(E_ALL); if(isset($_POST['editorId']) && isset($_POST['post']) && isset($_POST['validation'])) { require './config.php'; if($_POST['editorId'] === EDITOR_ID) { require './functions.php'; $post = json_decode($_POST['post']); define('DIR_NAME', buildName($post->title)); define('OUTPUT_DIR_PATH', OUTPUT_DIR . '/' . DIR_NAME); define('OUTPUT_FILE_NAME', 'index' . $extension); define('INPUT_DIR_PATH', INPUT_DIR . '/' . DIR_NAME); define('INPUT_FILE_NAME', 'draft.txt'); if($_POST['validation'] === 'false') { echo is_dir(INPUT_DIR_PATH) ? 'update' : 'release'; exit; } else if($_POST['validation'] === 'true') { if(!is_dir(INPUT_DIR_PATH)) { mkdir(INPUT_DIR_PATH); } file_put_contents(INPUT_DIR_PATH . '/' . INPUT_FILE_NAME, $_POST['post']); $isDraft = $post->isDraft; if($isDraft) { if(is_dir(OUTPUT_DIR_PATH)) { if(is_file(OUTPUT_DIR_PATH . '/' . OUTPUT_FILE_NAME)) { unlink(OUTPUT_DIR_PATH . '/' . OUTPUT_FILE_NAME); } rmdir(OUTPUT_DIR_PATH); } } else { require './template.php'; require './regex.php'; $output = (object) array( 'date' => $post->date, 'class' => buildName($post->class), 'title' => $post->title, 'introduction' => runEditor($post->introduction, $regex), 'sections' => [] ); if($post->sections != null) { foreach ($post->sections as $section) { array_push($output->sections, (object) array( 'title' => $section->title, 'content' => runEditor($section->content, $regex) ) ); } } if(!is_dir(OUTPUT_DIR_PATH)) { mkdir(OUTPUT_DIR_PATH); } file_put_contents(OUTPUT_DIR_PATH . '/' . OUTPUT_FILE_NAME, buildPost($output)); } $list = json_decode(file_get_contents(POSTS_INDEX)); for($i = 0, $l = count($list); $i < $l; $i++) { if($list[$i]->dir === DIR_NAME) { array_splice($list, $i, 1); break; } } array_unshift($list, (object) array( "date" => $post->date, "title" => $post->title, "dir" => DIR_NAME, "isDraft" => $isDraft ) ); file_put_contents(POSTS_INDEX, json_encode($list)); echo 'success'; } } }