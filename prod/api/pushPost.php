<?php
 if(isset($_POST['editorId']) && isset($_POST['post']) && isset($_POST['validation'])) { require './config.php'; if($_POST['editorId'] === EDITOR_ID) { $post = json_decode($_POST['post']); $n = strtolower($post->title); $n = str_replace([' ','à','á','â','ã','ä','ç','é','è','ê','ë','ì','í','î','ï','ò','ó','ô','õ','ö','š','ú','ù','û','ü','ý','ÿ','ž'], ['-','a','a','a','a','a','c','e','e','e','e','i','i','i','i','o','o','o','o','o','s','u','u','u','u','y','y','z'], $n); $n = str_replace([' ', '\''], ['-','-'], $n); $n = preg_replace('/[^a-zA-Z0-9\-]/', '', $n); $n = preg_replace('/\-{2,}/', '-', $n); $n = preg_replace('/^\-/', '', $n); $n = preg_replace('/\-$/', '', $n); define('POST_DIR_NAME', $n); define('POST_OUTPUT_DIR', OUTPUT_DIR . '/' . POST_DIR_NAME); define('POST_INPUT_DIR', INPUT_DIR . '/' . POST_DIR_NAME); if($_POST['validation'] === 'false') { echo is_dir(POST_INPUT_DIR) ? 'update' : 'release'; exit; } else if($_POST['validation'] === 'true') { $posts = json_decode(file_get_contents(JSON_INDEX)); for($i = 0, $l = count($posts); $i < $l; $i++) { if($posts[$i]->dir === POST_DIR_NAME) { array_splice($posts, $i, 1); break; } } array_unshift($posts, (object) array( 'date' => $post->date, 'title' => $post->title, 'dir' => POST_DIR_NAME, 'isDraft' => $post->isDraft, ) ); file_put_contents(JSON_INDEX, json_encode($posts)); require './tpl-index.php'; file_put_contents(HTML_INDEX, buildHtmlIndex($posts)); if(!is_dir(POST_INPUT_DIR)) { mkdir(POST_INPUT_DIR); } file_put_contents(POST_INPUT_DIR . '/' . INPUT_FILENAME, $_POST['post']); if($post->isDraft) { if(is_dir(POST_OUTPUT_DIR)) { if(is_file(POST_OUTPUT_DIR . '/' . OUTPUT_FILENAME)) { unlink(POST_OUTPUT_DIR . '/' . OUTPUT_FILENAME); } rmdir(POST_OUTPUT_DIR); } } else { require './tpl-post.php'; require './regex.php'; function runEditor ($input, $regex) { $output = $input; $output = preg_replace('/(<([^>]+)>)/i', '', $output); for($i = 0, $l = count($regex); $i < $l; $i++) { $output = preg_replace_callback($regex[$i]['desc'], $regex[$i]['output'], $output); } return $output; } $output = (object) array( 'date' => $post->date, 'title' => $post->title, 'introduction' => runEditor($post->introduction, $regex), 'sections' => [] ); if($post->sections != null) { foreach ($post->sections as $section) { array_push($output->sections, (object) array( 'title' => $section->title, 'content' => runEditor($section->content, $regex) ) ); } } if(!is_dir(POST_OUTPUT_DIR)) { mkdir(POST_OUTPUT_DIR); } file_put_contents(POST_OUTPUT_DIR . '/' . OUTPUT_FILENAME, buildHtmlPost($output)); } echo 'success'; } } }